# System Design Visualizer - Cursor Rules

## Project Overview
This is an interactive system design visualizer that transforms static system design diagrams into explorable, interactive visualizations using AI. The application uses OpenAI GPT-4o to analyze images and generate Mermaid diagrams, which are then converted to interactive React Flow graphs.

## Tech Stack
- **Frontend Framework**: React 19.2.0 with Vite 7.2.4
- **Styling**: Tailwind CSS 4.1.17 with CSS custom properties for theming
- **Visualization**: React Flow 11.11.4 (interactive graphs), Mermaid.js 11.12.1 (diagram rendering)
- **AI Integration**: OpenAI GPT-4o (Vision & Code Generation)
- **Icons**: Lucide React
- **Utilities**: clsx, tailwind-merge
- **Linting**: ESLint with React hooks and refresh plugins

## Project Structure
```
src/
├── App.jsx                # Root component; owns nodes/edges state
├── store/
│   ├── diagramStore.ts    # Zustand store (undo/redo, persistence, UI state)
│   ├── types.ts           # TypeScript type definitions
│   └── ...                # simulationTypes, integrationTypes, etc.
├── components/            # React components and ReactFlow canvas
│   ├── CustomNodes.jsx    # React Flow node components (Database, Server, Client, etc.)
│   ├── SubflowNode.jsx    # Grouping container node
│   ├── InfoPanel.jsx      # Side panel showing node details
│   ├── MermaidDisplay.jsx # Mermaid diagram renderer
│   ├── SystemDiagram.jsx  # Main React Flow diagram component
│   ├── CommandPalette.jsx # Cmd+K command palette
│   ├── AIChatPanel.jsx    # AI chat panel
│   └── ...                # UploadZone, ThemeToggle, panels, etc.
├── config/
│   └── nodeTypes.js       # Node type registry for React Flow
├── contexts/
│   ├── ThemeContext.jsx   # Theme provider and context implementation
│   └── ThemeContextDef.js # Theme context type definition
├── hooks/
│   ├── useTheme.js        # Custom hook for theme access
│   ├── useDiagram.ts      # Store-bound diagram helpers
│   └── useKeyboardShortcuts.ts
├── services/
│   ├── analysisService.js # All OpenAI API calls (image→Mermaid, Mermaid→Flow, spec→C4, code gen)
│   ├── chatService.js     # AI chat panel backend
│   ├── aiCopilotService.ts# Copilot-style suggestions
│   ├── layoutService.ts   # Dagre auto-layout helpers
│   ├── exportService.ts   # PNG/SVG/JSON export
│   ├── importService.ts   # JSON import
│   ├── costEstimationService.ts
│   ├── iacGenerationService.ts
│   ├── observabilityService.ts
│   ├── repositoryScanner.ts
│   └── simulationEngine.ts
└── themes/
    └── index.js           # Theme definitions (dark/light) with CSS custom properties
```

For detailed agent guidelines (state systems, shortcuts, conventions), see **AGENTS.md**.

## Code Style & Conventions

### React Components
- Use functional components with hooks
- Use `memo()` for custom node components to optimize React Flow rendering
- Prefer named exports for reusable components
- Use `useState`, `useEffect`, `useCallback`, and `useMemo` appropriately
- Keep components focused and single-purpose

### Styling Approach
- **Primary Method**: CSS custom properties (CSS variables) defined in `themes/index.js`
- **Secondary Method**: Tailwind CSS utility classes
- **Theme System**: All colors, shadows, and theme-specific values use CSS variables
- **Variable Naming**: Follow the pattern `--category-specific` (e.g., `--bg-primary`, `--text-secondary`, `--accent-blue`)
- **Inline Styles**: Use for CSS variable references: `style={{ backgroundColor: "var(--bg-primary)" }}`
- **Tailwind Classes**: Use for layout, spacing, and non-theme utilities

### File Naming
- Components: PascalCase (e.g., `SystemDiagram.jsx`)
- Services/utilities: camelCase (e.g., `analysisService.js`)
- Config files: camelCase (e.g., `nodeTypes.js`)
- Use `.jsx` extension for React components

### State Management
- **Two parallel state systems** — when modifying diagram state, check which system the target reads from:
  1. **App.jsx local state** (`useState`) — `nodes`, `edges`, and most UI flags. ReactFlow canvas and InfoPanel consume this.
  2. **Zustand `diagramStore`** — undo/redo history, `savedDiagrams`, command palette state, selection. Keyboard shortcuts (`useKeyboardShortcuts`) read from the store.
- Do not introduce a third state system. Use either App.jsx local state or the Zustand store.
- Use Context API (`ThemeContext`) for global theme state only.

### API Integration
- All AI/OpenAI calls go through `src/services/` (e.g. `analysisService.js`, `chatService.js`). Do not call the OpenAI API directly from components.
- Primary AI service: `services/analysisService.js` (image→Mermaid, Mermaid→Flow, spec→C4, code gen). When `VITE_OPENAI_API_KEY` is absent, mock data is used.
- Handle errors gracefully with user-friendly messages; use async/await for API calls.

## Architecture Patterns

### Theme System
- Themes are defined in `themes/index.js` as objects with CSS custom properties
- `ThemeProvider` applies theme variables to document root
- Theme preference is stored in localStorage with key `sdv-theme`
- System preference detection for initial theme
- All components access theme via `useTheme()` hook or CSS variables

### Node Types
- Custom React Flow nodes are in `components/CustomNodes.jsx`; grouping container in `components/SubflowNode.jsx`
- All nodes extend a `BaseNode` component for consistency (except SubflowNode)
- Node types are registered in `config/nodeTypes.js`. **Always validate node types** against this list; invalid types fall back to `serverNode`.
- Seven semantic types:
  - `databaseNode`: Emerald (Database icon)
  - `serverNode`: Blue (Server icon)
  - `clientNode`: Purple (Smartphone icon)
  - `loadBalancerNode`: Orange (Globe icon)
  - `cacheNode`: Yellow (Layers icon)
  - `userNode`: Human actors
  - `subflowNode`: Grouping container — must have `zIndex: -1` and explicit `style: { width, height }` so child nodes can be selected through them.

### Component Communication
- Props for parent-to-child communication
- Callback functions for child-to-parent communication (e.g., `onNodeClick`, `onUpload`)
- Context API for theme (global state)

### Key Conventions
- **Edge types**: Use one of `straight`, `smoothstep`, `step`, `default` (Bezier). Default is `straight`.
- **Node positions**: Validate `position.x` and `position.y` are numbers before passing to ReactFlow. Use a fallback grid (e.g. `250 + (i % 3) * 200, 100 + floor(i/3) * 150`) when missing.
- **IDs**: Use `nanoid()` for new nodes/edges in the store; legacy pattern in `handleApplyAIActions` (App.jsx) uses `` `ai-node-${Date.now()}-${index}-...` ``.
- **Persistence**: `diagramStore` uses localStorage key `sdv-diagram-storage`. App.jsx may also persist `savedDiagrams` separately — be aware of both when touching save/load.
- **Node type strings**: Do not hard-code outside `config/nodeTypes.js` and the `validNodeTypes` arrays in `analysisService.js` and `App.jsx`.

## Important Patterns

### React Flow Integration
- Always wrap `SystemDiagram` with `ReactFlowProvider`
- Use `useNodesState` and `useEdgesState` hooks for node/edge management
- Memoize `nodeTypes` object to prevent unnecessary re-renders
- Use `fitView` prop for automatic viewport fitting

### Mermaid Integration
- Initialize Mermaid with theme-aware configuration
- Re-initialize Mermaid when theme changes
- Use `mermaid.render()` for dynamic diagram generation
- Handle SVG rendering in useEffect with proper cleanup

### Error Handling
- Wrap API calls in try-catch blocks
- Provide fallback to mock data when API fails
- Show user-friendly error messages (alerts for now)
- Log errors to console for debugging

### Performance Considerations
- Use `memo()` for custom node components
- Memoize expensive computations with `useMemo`
- Use `useCallback` for event handlers passed to children
- Clean up object URLs created with `URL.createObjectURL()`

## Environment Variables
- `VITE_OPENAI_API_KEY`: OpenAI API key for AI features (optional - falls back to mock data)

## Development Guidelines

### Adding New Features
1. **New Components**: Create in `src/components/` with PascalCase naming
2. **New Services**: Add to `src/services/` for API or utility functions
3. **New Node Types**: 
   - Add component in `CustomNodes.jsx`
   - Register in `config/nodeTypes.js`
   - Update OpenAI prompt in `analysisService.js` if needed
4. **Styling**: Always use CSS variables for theme-aware styling

### Code Quality
- Follow ESLint rules (configured in `eslint.config.js`)
- Use React hooks rules (hooks at top level, proper dependencies)
- Avoid unused variables (except those starting with uppercase for constants)
- Use meaningful variable and function names

### Testing Considerations
- Mock mode is available when no API key is provided
- Components should handle missing/null data gracefully
- Test with both dark and light themes

## Common Tasks

### Adding a New Theme
1. Add theme object to `themes/index.js`
2. Ensure all required CSS variables are defined
3. Update `ThemeProvider` if needed
4. Test all components in new theme

### Adding a New Node Type
1. Create node component in `CustomNodes.jsx` using `BaseNode` (or `SubflowNode.jsx` for grouping)
2. Export and register in `config/nodeTypes.js`
3. Add the type to `validNodeTypes` in `analysisService.js` and `App.jsx`
4. Update OpenAI prompt in `convertToFlowWithOpenAI()` (or equivalent) in `analysisService.js` to include the new type
5. Test with mock data first

### Modifying API Prompts
- Edit prompts in `services/analysisService.js`
- `generateMermaidWithOpenAI`: System prompt for Mermaid generation
- `convertToFlowWithOpenAI`: System prompt for React Flow conversion
- Always specify JSON response format for Flow conversion

## Keyboard Shortcuts (implemented)
- `Cmd/Ctrl+K` — Command palette
- `Cmd/Ctrl+Z` / `Cmd/Ctrl+Shift+Z` — Undo / Redo
- `Cmd/Ctrl+S` — Save diagram
- `Cmd/Ctrl+D` — Duplicate selected node
- `Cmd/Ctrl+C/V` — Copy/paste node via clipboard
- `Cmd/Ctrl+E` — Export JSON
- `Delete/Backspace` — Delete selected node or edge
- `Escape` — Clear selection, close palette
- Arrow keys — Nudge node (1px; Shift = 10px)

## Best Practices
- **Do not mess up with the working pieces** — Enhance and fix things carefully.
- Preserve existing functionality when adding features.
- Maintain theme consistency; use CSS variables for all theme-dependent values.
- Keep components small and focused; document complex logic; handle edge cases; clean up resources (object URLs, event listeners).
- Do not use `git add -A` or commit without explicit user instruction.

## What to Avoid
- Do not introduce a third state system (use only App.jsx state or Zustand store).
- Do not call the OpenAI API directly from components — use `src/services/`.
- Do not hard-code node type strings outside `config/nodeTypes.js` and the `validNodeTypes` arrays in `analysisService.js` and `App.jsx`.

## Dependencies to Be Aware Of
- `reactflow`: Requires `ReactFlowProvider` wrapper
- `mermaid`: Must be initialized before use, theme-aware
- `lucide-react`: Icon library used throughout
- `clsx`: For conditional class names
- `tailwind-merge`: For merging Tailwind classes (if needed)

## Notes
- The app works in "Mock Mode" when no OpenAI API key is provided
- All theme colors are defined as CSS custom properties for easy theming
- React Flow nodes are memoized for performance
- The application uses a three-panel layout: Original Image, Mermaid Diagram, Interactive Graph

